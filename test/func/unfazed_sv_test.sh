#!/bin/bash

test -e ssshtest || wget -q https://raw.githubusercontent.com/ryanlayer/ssshtest/master/ssshtest
. ssshtest

STOP_ON_FAIL=1
data_path="test/data/"
func_path="test/func/"

bam=$data_path"NA12878.bam"
sites_vcf=$data_path"trio_snvs_chr22.vcf.gz"
sv_hets_vcf=$data_path"trio_hets_svs_chr22.vcf.gz"
sv_hets_bed=$data_path"trio_hets_svs_chr22.bed"
ped=$data_path"trio.ped"
missing_kid_ped=$data_path"trio_missing_kid.ped"
missing_dad_ped=$data_path"trio_missing_dad.ped"


printf "\n\nSV phasing tests" 
echo "##########################################################################"

run phase_sv_vcf_to_bed \
    unfazed \
        -d $sv_hets_vcf \
        -s $sites_vcf \
        -p $ped \
        -o bed\
        -g 38 \
        --quiet \
        --verbose \
        --bam-pairs "NA12878":$bam
if [ $phase_sv_vcf_to_bed ]; then
    assert_exit_code 0
    assert_in_stdout '#chrom	start	end	vartype	kid	origin_parent	other_parent	evidence_count	evidence_types	origin_parent_sites'
    assert_in_stdout '22	17770349	17779108	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	17773763,17774449	-	-	-'
    assert_in_stdout '22	17898548	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	17898552	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	18099531	18099826	DEL	NA12878	NA12892	NA12891	19	READBACKED	18097734,18097926,18098049,18098147,18098265,18098365,18098431,18098526,18098738,18098742,18098810,18098887,18099027,18099171,18099313,18099344,18099369,18099392,18100103'
    assert_in_stdout '22	18977575	18977640	DEL	NA12878	NA12891	NA12892	1	READBACKED	18977417'
    assert_in_stdout '22	19099931	19100625	DEL	NA12878	NA12892	NA12891	11	READBACKED	19098965,19099279,19099418,19099551,19099646,19099719,19099812,19099813,19099816,19099819,19100954'
    assert_in_stdout '22	20950622	20953839	DEL	NA12878	NA12892	NA12891	1	READBACKED	20954213'
    assert_in_stdout '22	22928304	22928441	DEL	NA12878	NA12892	NA12891	23	READBACKED	22926122,22926388,22926405,22926574,22926634,22926692,22926950,22926993,22927040,22927042,22927134,22927336,22927417,22927567,22927653,22927685,22927792,22928025,22928152,22928181,22928562,22928609,22928697'
    assert_in_stdout '22	24195940	24198505	DEL	NA12878	NA12892	NA12891	3	READBACKED	24195831,24195881,24198534'
    assert_in_stdout '22	25396176	25396406	DEL	NA12878	NA12892	NA12891	1	READBACKED	25396692'
    assert_in_stdout '22	25692160	25988583	DEL	NA12878	NA12891	NA12892	1	ALLELE-BALANCE	25801484	-	-	-'
    assert_in_stdout '22	27375695	27375778	DEL	NA12878	NA12891	NA12892	2	READBACKED	27375528,27376042'
    assert_in_stdout '22	33295771	33296076	DEL	NA12878	NA12892	NA12891	2	READBACKED	33296106,33296138	'
    assert_in_stdout '22	33751616	33751766	DEL	NA12878	NA12891	NA12892	1	READBACKED	33751862'
    assert_in_stdout '22	35645165	35646139	DEL	NA12878	NA12892	NA12891	1	READBACKED	35646477'
    assert_in_stdout '22	37905701	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	37905870	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	39607666	39607972	DEL	NA12878	NA12892	NA12891	6	READBACKED	39607613,39607629,39608079,39608192,39608297,39608299'
    assert_in_stdout '22	42519292	42531351	DEL	NA12878	NA12892	NA12891	2	READBACKED	42530825,42531209'
    assert_in_stdout '22	42523630	42537254	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	42523210,42523408,42523527,42536063,42536923,42537022,42537195,42537270,42537279,42537596'
    assert_in_stdout '22	43101462	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101463	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101514	43102189	DEL	NA12878	NA12892	NA12891	1	READBACKED	43101396'
    assert_in_stdout '22	43549344	43549651	DEL	NA12878	NA12892	NA12891	1	READBACKED	43549738'
    assert_in_stdout '22	45252442	45253079	DEL	NA12878	NA12892	NA12891	26	READBACKED	45251168,45251422,45251459,45251712,45251810,45251946,45252173,45252231,45252284,45252365,45253320,45253332,45253463,45253465,45253469,45253502,45253510,45253635,45253709,45253717,45253763,45253773,45253830,45253834,45253871,45253894'
    assert_in_stdout '22	49077625	49077902	DEL	NA12878	NA12891	NA12892	1	READBACKED	49078212'
    assert_in_stdout '22	50301956	50302007	DEL	NA12878	NA12892	NA12891	1	READBACKED	50302269'
fi


run phase_sv_bed_to_bed \
    unfazed \
        -d $sv_hets_bed \
        -s $sites_vcf \
        -p $ped \
        --quiet \
        -o bed\
        -g 38 \
        --verbose \
        --bam-pairs "NA12878":$bam
if [ $phase_sv_bed_to_bed ]; then
    assert_exit_code 0
    assert_in_stdout '#chrom	start	end	vartype	kid	origin_parent	other_parent	evidence_count	evidence_types	origin_parent_sites'
    assert_in_stdout '22	17770349	17779108	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	17773763,17774449	-	-	-'
    assert_in_stdout '22	17898548	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	17898552	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	18099531	18099826	DEL	NA12878	NA12892	NA12891	19	READBACKED	18097734,18097926,18098049,18098147,18098265,18098365,18098431,18098526,18098738,18098742,18098810,18098887,18099027,18099171,18099313,18099344,18099369,18099392,18100103'
    assert_in_stdout '22	18977575	18977640	DEL	NA12878	NA12891	NA12892	1	READBACKED	18977417'
    assert_in_stdout '22	19099931	19100625	DEL	NA12878	NA12892	NA12891	11	READBACKED	19098965,19099279,19099418,19099551,19099646,19099719,19099812,19099813,19099816,19099819,19100954'
    assert_in_stdout '22	20950622	20953839	DEL	NA12878	NA12892	NA12891	1	READBACKED	20954213'
    assert_in_stdout '22	22928304	22928441	DEL	NA12878	NA12892	NA12891	23	READBACKED	22926122,22926388,22926405,22926574,22926634,22926692,22926950,22926993,22927040,22927042,22927134,22927336,22927417,22927567,22927653,22927685,22927792,22928025,22928152,22928181,22928562,22928609,22928697'
    assert_in_stdout '22	24195940	24198505	DEL	NA12878	NA12892	NA12891	3	READBACKED	24195831,24195881,24198534'
    assert_in_stdout '22	25396176	25396406	DEL	NA12878	NA12892	NA12891	1	READBACKED	25396692'
    assert_in_stdout '22	25692160	25988583	DEL	NA12878	NA12891	NA12892	1	ALLELE-BALANCE	25801484	-	-	-'
    assert_in_stdout '22	27375695	27375778	DEL	NA12878	NA12891	NA12892	2	READBACKED	27375528,27376042'
    assert_in_stdout '22	33295771	33296076	DEL	NA12878	NA12892	NA12891	2	READBACKED	33296106,33296138	'
    assert_in_stdout '22	33751616	33751766	DEL	NA12878	NA12891	NA12892	1	READBACKED	33751862'
    assert_in_stdout '22	35645165	35646139	DEL	NA12878	NA12892	NA12891	1	READBACKED	35646477'
    assert_in_stdout '22	37905701	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	37905870	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	39607666	39607972	DEL	NA12878	NA12892	NA12891	6	READBACKED	39607613,39607629,39608079,39608192,39608297,39608299'
    assert_in_stdout '22	42519292	42531351	DEL	NA12878	NA12892	NA12891	2	READBACKED	42530825,42531209'
    assert_in_stdout '22	42523630	42537254	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	42523210,42523408,42523527,42536063,42536923,42537022,42537195,42537270,42537279,42537596'
    assert_in_stdout '22	43101462	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101463	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101514	43102189	DEL	NA12878	NA12892	NA12891	1	READBACKED	43101396'
    assert_in_stdout '22	43549344	43549651	DEL	NA12878	NA12892	NA12891	1	READBACKED	43549738'
    assert_in_stdout '22	45252442	45253079	DEL	NA12878	NA12892	NA12891	26	READBACKED	45251168,45251422,45251459,45251712,45251810,45251946,45252173,45252231,45252284,45252365,45253320,45253332,45253463,45253465,45253469,45253502,45253510,45253635,45253709,45253717,45253763,45253773,45253830,45253834,45253871,45253894'
    assert_in_stdout '22	49077625	49077902	DEL	NA12878	NA12891	NA12892	1	READBACKED	49078212'
    assert_in_stdout '22	50301956	50302007	DEL	NA12878	NA12892	NA12891	1	READBACKED	50302269'
fi

#split the next two tests to decrease the amount of text to stdout
rm -f out.tmp
unfazed \
    -d $sv_hets_vcf \
    -s $sites_vcf \
    -p $ped \
    --quiet \
    --outfile out.tmp\
    -g 38 \
    --bam-pairs "NA12878":$bam


if [ "$(uname)" == "Darwin" ]; then
    grep_header=(grep -E 'FORMAT=<ID=(UOP|UOPS|UET)' out.tmp )
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    grep_header=(grep -E 'FORMAT=<ID=(UOP|UOPS|UET)' out.tmp )
fi

run phase_sv_vcf_to_vcf_header \
    "${grep_header[@]}"
if [ $phase_sv_vcf_to_vcf_header ]; then
    assert_exit_code 0
    assert_in_stdout '##FORMAT=<ID=UOPS,Number=1,Type=Float,Description="Count of pieces of evidence supporting the unfazed-identified origin parent or `-1` if missing">'
    assert_in_stdout '##FORMAT=<ID=UET,Number=1,Type=Float,Description="Unfazed evidence type: `0` (readbacked), `1` (allele-balance, for CNVs only), `2` (both), `3` (ambiguous readbacked), `4` (ambiguous allele-balance), `5` (ambiguous both), `6` (auto-phased sex-chromosome variant in male), or `-1` (missing)">'
fi

run phase_sv_vcf_to_vcf_body \
    grep -v "#" out.tmp | grep "UOPS" | cut -f 9-12
if [ $phase_sv_vcf_to_vcf_body ]; then
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:200:650.44:-67,-2,-25:75:45:30:44:29:27:11:4:17:13:0.4:2:1	0/1:165:239.71:-26,-2,-19:43:29:13:28:12:17:3:2:11:6:0.3:-1:-1	0/1:200:452.56:-47,-2,-23:61:39:22:38:21:24:9:1:14:10:0.36:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:100:137.83:-15,-2,-12:25:17:7:17:7:17:5:1:0:0:0.29:9:0	0/0:81:0:-0,-8,-27:27:27:0:27:0:27:0:0:0:0:0:-1:-1	0/1:74:74.77:-12,-4,-23:36:29:6:29:6:29:5:0:0:0:0.17:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:71:305.78:-31,-1,-8:29:15:13:15:13:15:11:1:0:0:0.46:9:0	0/0:78:0:-0,-8,-26:26:26:0:26:0:26:0:0:0:0:0:-1:-1	0/1:123:257.75:-27,-1,-14:35:22:12:22:12:22:10:1:0:0:0.35:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:66:152.86:-16,-1,-8:20:12:7:12:7:12:5:1:0:0:0.37:-1:-1	0/0:75:0:-0,-8,-25:25:25:0:25:0:25:0:0:0:0:0:-1:-1	0/1:98:98.81:-13,-3,-16:28:21:6:21:6:21:5:0:0:0:0.22:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:281.6:-32,-4,-28:59:42:16:41:15:25:7:0:16:7:0.27:29:0	0/0:144:0:-0,-14,-48:49:49:0:48:0:26:0:0:22:0:0:-1:-1	1/1:117:1358.95:-138,-14,-2:49:1:47:0:46:0:26:1:0:18:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:89:116.85:-13,-2,-11:22:15:6:15:6:15:3:2:0:0:0.29:1:0	1/1:53:620.39:-63,-6,-1:21:0:21:0:21:0:15:5:0:0:1:-1:-1	0/1:29:29.87:-6,-3,-14:21:17:3:17:3:17:2:0:0:0:0.15:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:737.42:-75,-1,-23:77:43:33:42:32:25:14:2:17:15:0.43:11:0	0/0:200:0:-0,-29,-96:97:97:0:96:0:61:0:0:35:0:0:-1:-1	0/1:200:452.49:-48,-3,-30:72:48:23:47:22:30:7:4:17:10:0.32:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:86:86.79:-12,-3,-19:34:26:7:25:6:15:3:0:10:2:0.19:1:0	0/0:200:0:-0,-25,-83:84:84:0:83:0:49:0:0:34:0:0:-1:-1	1/1:97:1122.61:-114,-11,-2:39:0:39:0:38:0:14:5:0:18:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:135:200.76:-22,-2,-15:34:23:10:23:10:23:7:3:0:0:0.3:30:0	0/0:108:0:-0,-11,-36:36:36:0:36:0:36:0:0:0:0:0:-1:-1	0/1:70:176.84:-19,-1,-8:21:13:8:13:8:13:3:4:0:0:0.38:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:38:38.38:-6,-2,-6:82:72:9:71:8:40:0:4:31:3:0.1:-1:-1	0/0:69:0:-0,-7,-13:76:76:0:75:0:46:0:0:29:0:0:-1:-1	0/1:32:86.72:-10,-1,-5:90:76:13:75:12:45:0:4:30:8:0.14:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:158:242.72:-26,-2,-18:42:28:13:27:12:14:3:1:13:7:0.31:3:0	0/1:127:566.59:-58,-1,-14:54:28:25:27:24:18:14:1:9:8:0.47:-1:-1	1/1:89:1033.98:-105,-11,-2:36:0:36:0:35:0:15:3:0:16:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:143:326.69:-34,-2,-16:44:27:16:26:15:10:0:2:16:13:0.37:2:0	0/0:24:0.02:-5,-8,-31:39:35:3:35:3:35:0:2:0:0:0.079:-1:-1	1/1:58:679.48:-69,-7,-1:25:0:24:0:23:0:0:3:0:19:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:182:182.66:-23,-4,-28:50:38:11:38:11:38:9:1:0:0:0.22:-1:-1	0/0:180:0:-1,-19,-67:73:70:2:69:1:43:0:0:26:1:0.014:-1:-1	0/0:66:0:-3,-10,-37:43:40:2:40:2:40:1:0:0:0:0.048:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:122:122.8:-15,-3,-16:30:22:7:22:7:0:0:0:22:7:0.24:1:1	0/1:35:35.82:-8,-4,-20:29:24:4:24:4:0:0:0:24:4:0.14:-1:-1	0/1:98:98.81:-13,-3,-16:28:21:6:21:6:0:0:0:21:6:0.22:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:119:119.73:-16,-4,-24:41:32:8:32:8:32:7:0:0:0:0.2:-1:-1	0/1:59:59.67:-13,-7,-35:51:43:7:43:7:43:5:1:0:0:0.14:-1:-1	0/1:200:221.67:-25,-3,-24:47:34:12:34:12:34:9:2:0:0:0.26:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:200:515.49:-54,-2,-27:71:45:25:44:24:27:13:1:17:9:0.35:-1:-1	0/1:200:425.44:-47,-4,-38:81:57:23:56:22:37:10:2:19:9:0.28:-1:-1	0/1:159:656.52:-67,-1,-17:64:34:29:33:28:20:16:2:13:9:0.46:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:90:245.79:-26,-1,-10:29:17:11:17:11:17:7:3:0:0:0.39:2:0	1/1:56:649.93:-66,-7,-1:22:0:22:0:22:0:19:2:0:0:1:-1:-1	0/0:135:0:-0,-14,-45:45:45:0:45:0:45:0:0:0:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:200:356.37:-43,-7,-51:94:71:22:70:21:40:11:3:30:6:0.23:-1:-1	0/1:71:71.38:-21,-14,-70:99:85:13:84:12:51:5:3:33:3:0.12:-1:-1	0/0:200:0:-0,-22,-73:74:74:0:73:0:45:0:0:28:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:133:434.65:-45,-1,-14:46:26:19:26:19:26:16:2:0:0:0.42:1:0	0/1:116:260.75:-27,-1,-13:34:21:12:21:12:21:9:2:0:0:0.36:-1:-1	0/1:118:311.72:-32,-1,-13:37:22:14:22:14:22:12:1:0:0:0.39:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:200:491.51:-51,-2,-27:68:44:24:43:23:27:7:2:16:13:0.35:-1:-1	0/0:192:0:-0,-19,-64:65:65:0:64:0:43:0:0:21:0:0:-1:-1	0/1:200:344.6:-37,-3,-25:58:39:18:38:17:22:8:2:16:6:0.31:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:170:392.63:-41,-2,-19:51:32:19:31:18:17:7:3:14:7:0.37:2:0	0/1:142:482.62:-49,-1,-15:51:29:22:28:21:15:12:0:13:8:0.43:-1:-1	1/1:127:1477.12:-150,-15,-2:53:1:51:0:50:0:19:5:0:25:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:156:191.74:-22,-2,-18:37:26:10:26:10:26:6:3:0:0:0.28:1:0	1/1:71:827.19:-84,-8,-1:28:0:28:0:28:0:22:5:0:0:1:-1:-1	0/0:153:0:-0,-15,-51:51:51:0:51:0:51:0:0:0:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:470.53:-49,-2,-25:65:42:23:41:22:25:11:1:16:9:0.35:2:0	0/1:200:326.63:-35,-2,-23:54:36:17:35:16:23:5:1:12:10:0.31:-1:-1	1/1:125:1447.58:-147,-15,-2:50:0:50:0:49:0:18:6:0:24:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:74:200.82:-21,-1,-8:24:14:9:14:9:14:4:4:0:0:0.39:-1:-1	0/1:72:227.81:-24,-1,-8:25:14:10:14:10:14:6:3:0:0:0.42:-1:-1	0/1:105:161.81:-18,-2,-12:27:18:8:18:8:18:2:5:0:0:0.31:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:111:236.77:-25,-1,-13:32:20:11:20:11:0:0:0:20:11:0.35:22:0	0/0:200:0:-0,-23,-77:78:78:0:77:0:49:0:0:28:0:0:-1:-1	0/1:56:56.79:-10,-4,-21:32:26:5:26:5:0:0:0:26:5:0.16:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:167:167.63:-22,-5,-33:57:44:12:43:11:24:3:1:19:6:0.2:2:0	0/0:159:0:-0,-16,-53:55:54:0:53:0:30:0:0:23:0:0:-1:-1	1/1:61:709.02:-72,-7,-1:25:0:25:0:24:0:5:3:0:16:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:104:104.63:-17,-7,-37:57:47:10:46:9:27:1:1:19:6:0.16:2:0	0/0:132:0:-0,-13,-44:45:44:0:44:0:24:0:0:20:0:0:-1:-1	1/1:53:620.39:-63,-6,-1:22:0:22:0:21:0:2:3:0:16:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:248.6:-29,-4,-31:60:44:15:43:14:25:0:2:18:12:0.25:16:0	0/0:150:0:-0,-15,-50:53:51:1:50:0:29:0:0:21:0:0:-1:-1	0/1:25:299.84:-31,-1,-3:23:9:13:8:12:7:0:4:1:8:0.6:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:68:68.82:-10,-3,-17:28:22:5:22:5:0:0:0:22:5:0.19:-1:-1	0/1:59:59.86:-8,-2,-12:21:16:4:16:4:0:0:0:16:4:0.2:-1:-1	0/0:189:0:-0,-19,-63:64:64:0:63:0:38:0:0:25:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:89:89.67:-15,-6,-34:53:43:9:42:8:23:0:1:19:7:0.16:-1:-1	0/1:59:59.8:-10,-4,-20:33:26:6:25:5:15:0:1:10:4:0.17:-1:-1	0/0:183:0:-0,-18,-61:62:62:0:61:0:34:0:0:27:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:141:275.72:-29,-2,-16:39:25:13:25:13:0:0:0:25:13:0.34:2:0	0/0:66:0:-2,-8,-30:33:31:1:31:1:0:0:0:31:1:0.031:-1:-1	0/1:140:140.77:-17,-3,-18:34:25:8:25:8:0:0:0:25:8:0.24:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:173:287.68:-31,-2,-20:45:30:14:30:14:0:0:0:30:14:0.32:-1:-1	0/1:149:479.61:-49,-1,-16:51:29:21:29:21:0:0:0:29:21:0.42:-1:-1	0/0:200:0:-0,-26,-88:89:89:0:88:0:56:0:0:32:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:146:221.74:-24,-2,-17:39:26:12:25:11:13:0:2:12:9:0.31:-1:-1	0/0:165:0:-0,-17,-55:56:56:0:55:0:31:0:0:24:0:0:-1:-1	0/1:62:62.74:-12,-5,-27:41:33:7:33:6:19:0:1:14:5:0.15:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:248.66:-28,-3,-23:49:35:14:34:13:21:2:1:13:9:0.28:3:2	0/0:198:0:-0,-20,-66:67:67:0:66:0:40:0:0:26:0:0:-1:-1	1/1:64:817.19:-83,-7,-1:32:2:29:1:28:1:3:5:0:19:0.97:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:248.66:-28,-3,-23:49:35:14:34:13:21:2:1:13:9:0.28:3:2	0/0:200:0:-0,-20,-67:68:68:0:67:0:41:0:0:26:0:0:-1:-1	1/1:64:817.19:-83,-7,-1:32:2:29:1:28:1:3:5:0:19:0.97:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:239.65:-27,-4,-26:52:37:14:37:13:23:2:1:14:9:0.26:1:0	0/0:195:0:-0,-20,-65:66:66:0:65:0:40:0:0:25:0:0:-1:-1	1/1:56:649.93:-66,-7,-1:23:0:23:0:22:0:1:1:0:19:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:60:206.84:-22,-1,-7:22:12:9:12:9:0:0:0:12:9:0.43:-1:-1	0/0:192:0:-0,-19,-64:65:65:0:64:0:39:0:0:25:0:0:-1:-1	1/1:48:561.31:-57,-6,-1:19:0:19:0:19:0:0:0:0:19:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:95:269.77:-28,-1,-11:32:18:13:18:12:10:0:3:8:9:0.4:-1:-1	0/1:50:50.78:-10,-5,-23:36:29:6:28:5:16:0:0:12:5:0.15:-1:-1	1/1:51:590.85:-60,-6,-1:21:0:21:0:20:0:0:4:0:16:1:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:106:290.75:-30,-1,-12:36:21:14:20:13:12:0:4:8:9:0.39:7:0	0/1:50:50.72:-11,-6,-30:46:38:7:37:6:23:0:1:14:5:0.14:-1:-1	0/1:25:584.7:-60,-2,-4:38:13:24:12:23:10:0:7:2:16:0.66:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:71:71.89:-9,-2,-9:17:12:4:12:4:0:0:0:12:4:0.25:-1:-1	0/0:81:0:-0,-8,-27:27:27:0:27:0:14:0:0:13:0:0:-1:-1	0/1:33:140.9:-15,-1,-4:14:7:6:7:6:0:0:0:7:6:0.46:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:200:404.59:-43,-2,-22:58:37:20:36:19:21:3:2:15:13:0.35:64:0	0/0:189:0:-0,-19,-63:64:64:0:63:0:39:0:0:24:0:0:-1:-1	0/1:200:251.61:-29,-4,-30:59:43:15:42:14:26:5:3:16:6:0.25:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:38:38.89:-6,-2,-11:18:14:3:14:3:14:1:1:0:0:0.18:-1:-1	0/1:62:257.81:-27,-1,-7:25:13:11:13:11:13:7:3:0:0:0.46:-1:-1	0/1:77:173.83:-19,-1,-9:23:14:8:14:8:14:5:2:0:0:0.36:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:53:53.85:-8,-3,-14:22:18:4:18:4:0:0:0:18:4:0.18:-1:-1	0/1:135:200.76:-22,-2,-15:34:23:10:23:10:0:0:0:23:10:0.3:-1:-1	0/0:150:0:-0,-15,-50:50:50:0:50:0:29:0:0:21:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:26:26.87:-6,-3,-15:22:18:3:18:3:0:0:0:18:3:0.14:-1:-1	0/0:39:0:-2,-6,-21:24:22:1:22:1:0:0:0:22:1:0.043:-1:-1	0/1:21:197.91:-21,-1,-3:15:6:8:6:8:0:0:0:6:8:0.57:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:48:263.82:-27,-1,-6:23:11:11:11:11:0:0:0:11:11:0.5:-1:-1	0/1:75:122.86:-14,-1,-9:20:13:6:13:6:0:0:0:13:6:0.32:-1:-1	0/1:70:176.84:-19,-1,-8:21:13:8:13:8:0:0:0:13:8:0.38:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	1|0:200:560.45:-58,-2,-29:76:48:27:47:26:28:14:1:19:10:0.36:2:0	1/1:127:1477.12:-150,-15,-2:51:0:51:0:50:0:21:8:0:20:1:-1:-1	0/1:161:422.63:-44,-1,-18:52:31:20:30:19:19:9:2:11:7:0.39:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:200:587.44:-61,-2,-28:77:48:28:47:27:24:17:2:23:8:0.36:-1:-1	0/1:200:755.39:-77,-1,-24:81:46:34:45:33:23:22:1:22:10:0.42:-1:-1	0/1:200:791.34:-81,-2,-28:89:52:36:51:35:27:21:4:24:9:0.41:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:200:407.53:-44,-3,-29:67:45:21:44:20:24:8:3:20:8:0.31:-1:-1	0/1:200:230.63:-27,-4,-29:56:41:14:40:13:23:7:1:17:4:0.25:-1:-1	0/1:200:308.53:-35,-5,-35:70:51:18:50:17:33:6:4:17:6:0.25:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0|1:100:137.83:-15,-2,-12:25:17:7:17:7:17:2:5:0:0:0.29:9:0	0/0:90:0:-0,-9,-30:30:30:0:30:0:30:0:0:0:0:0:-1:-1	0/1:50:50.85:-8,-3,-15:24:19:4:19:4:19:3:1:0:0:0.17:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:79:146.84:-16,-1,-9:22:14:7:14:7:14:1:5:0:0:0.33:-1:-1	0/1:52:158.87:-17,-1,-6:18:10:7:10:7:10:2:4:0:0:0.41:-1:-1	0/0:45:0:-0,-5,-15:15:15:0:15:0:15:0:0:0:0:0:-1:-1'
    assert_in_stdout 'GT:GQ:SQ:GL:DP:RO:AO:QR:QA:RS:AS:ASC:RP:AP:AB:UOPS:UET	0/1:20:20.89:-6,-4,-17:24:20:3:20:3:20:1:1:0:0:0.13:-1:-1	0/0:51:0:-0,-5,-17:18:17:0:17:0:17:0:0:0:0:0:-1:-1	0/0:21:0.03:-2,-4,-15:18:16:1:16:1:16:0:0:0:0:0.059:-1:-1'
fi
rm out.tmp

run phase_sv_bed_to_bed_ambig \
    unfazed \
        -d $sv_hets_bed \
        -s $sites_vcf \
        --quiet \
        -p $ped \
        -o bed\
        -g 38 \
        --verbose \
        --include-ambiguous \
        --bam-pairs "NA12878":$bam
if [ $phase_sv_vcf_to_bed_ambig ]; then
    assert_in_stdout '#chrom	start	end	vartype	kid	origin_parent	other_parent	evidence_count	evidence_types	origin_parent_sites'
    assert_in_stdout '22	17770349	17779108	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	17773763,17774449	-	-	-'
    assert_in_stdout '22	17898548	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	17898552	17898617	DEL	NA12878	NA12892	NA12891	9	READBACKED	17897460,17897463,17897543,17897607,17897821,17897916,17898192,17898225,17898240'
    assert_in_stdout '22	18099531	18099826	DEL	NA12878	NA12892	NA12891	19	READBACKED	18097734,18097926,18098049,18098147,18098265,18098365,18098431,18098526,18098738,18098742,18098810,18098887,18099027,18099171,18099313,18099344,18099369,18099392,18100103'
    assert_in_stdout '22	18977575	18977640	DEL	NA12878	NA12891	NA12892	1	READBACKED	18977417'
    assert_in_stdout '22	19099931	19100625	DEL	NA12878	NA12892	NA12891	11	READBACKED	19098965,19099279,19099418,19099551,19099646,19099719,19099812,19099813,19099816,19099819,19100954'
    assert_in_stdout '22	20950622	20953839	DEL	NA12878	NA12892	NA12891	1	READBACKED	20954213'
    assert_in_stdout '22	22928304	22928441	DEL	NA12878	NA12892	NA12891	23	READBACKED	22926122,22926388,22926405,22926574,22926634,22926692,22926950,22926993,22927040,22927042,22927134,22927336,22927417,22927567,22927653,22927685,22927792,22928025,22928152,22928181,22928562,22928609,22928697'
    assert_in_stdout '22	24195940	24198505	DEL	NA12878	NA12892	NA12891	3	READBACKED	24195831,24195881,24198534'
    assert_in_stdout '22	25396176	25396406	DEL	NA12878	NA12892	NA12891	1	READBACKED	25396692'
    assert_in_stdout '22	25692160	25988583	DEL	NA12878	NA12891	NA12892	1	ALLELE-BALANCE	25801484	-	-	-'
    assert_in_stdout '22	27375695	27375778	DEL	NA12878	NA12891	NA12892	2	READBACKED	27375528,27376042'
    assert_in_stdout '22	33295771	33296076	DEL	NA12878	NA12892	NA12891	2	READBACKED	33296106,33296138	'
    assert_in_stdout '22	33751616	33751766	DEL	NA12878	NA12891	NA12892	1	READBACKED	33751862'
    assert_in_stdout '22	35645165	35646139	DEL	NA12878	NA12892	NA12891	1	READBACKED	35646477'
    assert_in_stdout '22	36088019	36094371	DEL	NA12878	NA12891|NA12892	None	36	AMBIGUOUS_READBACKED	36095334	E00334:153:HNYCJCCXX:2:2216:22221:21772,ST-E00297:174:HNW5WCCXX:8:1114:24434:65687,E00334:153:HNYCJCCXX:1:1215:26443:34781,ST-E00297:174:HNW5WCCXX:5:1218:24129:45013,E00286:178:HNWF2CCXX:5:2204:22871:14881,E00334:153:HNYCJCCXX:2:1215:7222:19416,E00334:153:HNYCJCCXX:8:1109:19898:57090,E00286:178:HNWF2CCXX:3:2123:26961:56458	36094416,36094485,36094582,36095333,36095334,36095340	E00334:153:HNYCJCCXX:2:2216:22221:21772,E00286:178:HNWF2CCXX:1:2117:9780:52537,E00334:153:HNYCJCCXX:1:1215:26443:34781,E00334:153:HNYCJCCXX:8:2119:17675:64597,E00286:178:HNWF2CCXX:1:1220:15635:58708,E00286:178:HNWF2CCXX:5:2214:26342:62698,ST-E00297:174:HNW5WCCXX:6:2123:4909:13931,E00334:153:HNYCJCCXX:2:2216:22871:52221,E00286:178:HNWF2CCXX:1:1108:16853:27943,E00286:178:HNWF2CCXX:3:2121:8542:35027,E00334:153:HNYCJCCXX:2:1102:11322:70926,E00286:178:HNWF2CCXX:5:2204:22871:14881,E00286:178:HNWF2CCXX:3:2207:21968:40178,E00334:153:HNYCJCCXX:2:1215:7222:19416,ST-E00297:174:HNW5WCCXX:8:2218:17614:30105,E00334:153:HNYCJCCXX:3:1106:18294:63032,ST-E00297:174:HNW5WCCXX:8:1114:24434:65687,ST-E00297:174:HNW5WCCXX:5:1218:24129:45013,E00334:153:HNYCJCCXX:6:2116:13443:61134,E00286:178:HNWF2CCXX:6:2222:19512:51711,E00334:153:HNYCJCCXX:8:1109:19898:57090,ST-E00297:174:HNW5WCCXX:8:2105:22485:41778,E00334:153:HNYCJCCXX:2:1206:9557:72965,E00286:178:HNWF2CCXX:2:1109:22100:42622,E00286:178:HNWF2CCXX:5:2209:21887:43167,E00334:153:HNYCJCCXX:3:1101:4462:20612,E00286:178:HNWF2CCXX:3:2109:13108:26484,E00286:178:HNWF2CCXX:3:2123:26961:56458'
    assert_in_stdout '22	37905701	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	37905870	37906155	DEL	NA12878	NA12892	NA12891	2	READBACKED	37905284,37905631'
    assert_in_stdout '22	39607666	39607972	DEL	NA12878	NA12892	NA12891	6	READBACKED	39607613,39607629,39608079,39608192,39608297,39608299'
    assert_in_stdout '22	42519292	42531351	DEL	NA12878	NA12892	NA12891	2	READBACKED	42530825,42531209'
    assert_in_stdout '22	42523630	42537254	DEL	NA12878	NA12891	NA12892	2	ALLELE-BALANCE	42523210,42523408,42523527,42536063,42536923,42537022,42537195,42537270,42537279,42537596'
    assert_in_stdout '22	43101462	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101463	43102189	DEL	NA12878	NA12892	NA12891	3	READBACKED,ALLELE-BALANCE	43101396,43101464,43101465,43101469'
    assert_in_stdout '22	43101514	43102189	DEL	NA12878	NA12892	NA12891	1	READBACKED	43101396'
    assert_in_stdout '22	43549344	43549651	DEL	NA12878	NA12892	NA12891	1	READBACKED	43549738'
    assert_in_stdout '22	45252442	45253079	DEL	NA12878	NA12892	NA12891	26	READBACKED	45251168,45251422,45251459,45251712,45251810,45251946,45252173,45252231,45252284,45252365,45253320,45253332,45253463,45253465,45253469,45253502,45253510,45253635,45253709,45253717,45253763,45253773,45253830,45253834,45253871,45253894'
    assert_in_stdout '22	49077625	49077902	DEL	NA12878	NA12891	NA12892	1	READBACKED	49078212'
    assert_in_stdout '22	50301956	50302007	DEL	NA12878	NA12892	NA12891	1	READBACKED	50302269'
fi
